<!DOCTYPE HTML>
<html>
	<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Resistance</title>
    <script src="3rd/jquery.min.js"></script>
    <script src="3rd/socket.io.min.js"></script>
    <link href="3rd/font-awesome.min.css" rel="stylesheet">
    <link href="3rd/bootstrap.min.css" rel="stylesheet">
    <link href="3rd/bootstrap-theme.min.css" rel="stylesheet">
    <script src="3rd/bootstrap.min.js"></script>
    <style>
      .label {
        font-size:100%;
      }
    </style>

		<script type="text/javascript">
      var playern = 0;
      function Fill(data) {
        if (data[0] == undefined) return;
        playern = data.n;
        $('#playern').html(data.n);
        $('#spyn').html(data.param[5]);
        for (var i = 0; i < 5; ++i) {
          if (data[i].votes != undefined) {
            var html = '';
            var result = 1;
            for (var j in data[i].votes) {
              var vote = data[i].votes[j];
              if (vote == 1) html += ' <span class="label label-success">Pass</span>';
              else html += ' <span class="label label-danger">Fail</span>';
              if (vote == 0) --result;
            }
            if (playern >= 7 && i == 3) {
              if (result == 0) result = 1;
            }
            if (result == 1) {
              $('#' + i).parent().parent().parent().removeClass('panel-info');
              $('#' + i).parent().parent().parent().addClass('panel-success');
              $('#' + i).parent().parent().addClass('bg-success');
            } else {
              $('#' + i).parent().parent().parent().removeClass('panel-info');
              $('#' + i).parent().parent().parent().addClass('panel-danger');
              $('#' + i).parent().parent().addClass('bg-danger');
            }
            $('#' + i).html(html);
          } else {
            $('#' + i).html(data[i].voten);
          }
          $('#voten' + i).html(data[i].n);
          if (i == 3 && playern >= 7) {
            $('#voten3').html(data[3].n + '*');
          }
        }
        html = '';
        for (var i in data.proposals) {
          var p = data.proposals[i];
          var votes = [];
          var yes = 0;
          var all = 0;
          for (var j in p) {
            if (j == 'who' || j == 'text') continue;
            ++all;
            if (p[j] == 1) {
              votes.push(' <span class="label label-success">' + unescape(j) + '</span>');
              ++yes;
            } else {
              votes.push(' <span class="label label-danger">' + unescape(j) + '</span>');
            }
          }
          if (yes > all / 2.0) {
            html += '<li class="list-group-item list-group-item-success">';
          } else {
            html += '<li class="list-group-item list-group-item-danger">';
          }
          html += unescape(p.who) + ': ' + unescape(p.text) + '<p>' + votes.join('') + '</p></li>';
        }
        $('#proposals').html(html);
        
        html = '';
        if (data.proposal['text'] != undefined) {
          var p = data.proposal;
          html += '<h3><span style="font-weight:bold">' + unescape(p.who) + '</span>: <span class="text-primary">' + unescape(p.text) + '</span></h3>'
          var votes = [];
          for (var j in p) {
            if (j == 'who' || j == 'text') continue;
            votes.push('<span class="label label-warning">' + unescape(j) + '</span>');
          }
          html += '<p>' + votes.join(' ') + '</p>';
        }
        $('#proposal').html(html);
      }
      function Propose() {
        var text = [];
        $('input[type=checkbox]').each(function () {
          if (this.checked) text.push(this.value);
        });
        socket.emit('propose', {text: text.join(', ')});
      }
      function Join(data) {
        $('#joined').html(data.names.length);
        $('#names').html(unescape(data.names.join(' | ')));
        var html = '';
        for (var i in data.names) {
          var name = data.names[i];
          html += '<div class="checkbox"><label><input type="checkbox" value="' + name + '">' + unescape(name) + '</label></div>';
        }
        $('#name_checks').html(html);
      }
      var me = #name#;
      var socket = null;
      function ChangeName() {
        me = prompt("Please enter your name", me == null ? "Harry Potter" : me);
        if (me == null) me = 'UNKNOWN';
        $.post('/setname', {name: me}, function(data) {
          console.log(data);
        });
        $('#me').html(me);
        if (socket != null) {
          socket.emit('me', {'name': escape(me)});
        }
      }
      function Connect() {
        if (me == null) {
          ChangeName();
        }
        $('#me').html(me);
        socket = io();
        socket.on('connect', function(data) {
          $('#WARNING').html('CONNECTED');
          socket.emit('me', {'name': escape(me)});
        });
        socket.on('disconnect', function(data) {
          $('#WARNING').html('DISCONNECTED');
        });
        socket.on('votes', function(data) {
          Fill(data);
        });
        socket.on('join', function(data) {
          Join(data);
        });
        socket.on('role', function(data) {
          if (data.role == 0) {
            var msg = '';
            if (data.spys.length == 2) {
              msg += 'Your partner is ';
              for (var i in data.spys) {
                if (unescape(data.spys[i]) == me) continue;
                msg += unescape(data.spys[i]) + '.';
              }
            } else {
              msg += 'Your partners are ';
              var s = 0;
              for (var i in data.spys) {
                if (unescape(data.spys[i]) == me) continue;
                if (s == data.spys.length - 2) msg += ' and ';
                else if (s != 0) msg += ', ';
                msg += unescape(data.spys[i]);
                ++s;
              }
              msg += '.';
            }
            alert(me + ', you are a SPY. ' + msg);
          } else {
            alert(me + ', you are a RESISTANCE MEMBER.');
          }
        });
      }
      $(document).ready(Connect);
      function Start() {
        socket.emit('start');
      }
      function Pass(round) {
        socket.emit('vote', {round: round, vote: 1});
      }
      function Fail(round) {
        socket.emit('vote', {round: round, vote: 0});
      }
      function Yes() {
        socket.emit('yes');
      }
      function No() {
        socket.emit('no');
      }
		</script>
	</head>
	<body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" onclick="ChangeName()">Resistance <span style="font-weight:bolder;" id="me"></span></a>
        </div>
        <ul class="nav navbar-nav">
          <li><button class="btn navbar-btn btn-info" onclick="Start();">Start</button></li>
          <li><a><span id="WARNING"><span class="text-success">CONNECTED</span></span></a></li>
        </ul>
      </div>
    </nav>
    <div class="container-fluid">
        <h2>In Room (<span style="font-weight:bolder;" id="joined"></span>) <span class="text-primary" id="names"></span></h2>
        <div class="row">
          <div class="col-lg-4 col-md-6">
            <div class="panel panel-primary">
              <div class="panel-heading">
                Players number <span id="playern"></span>, Spys number <span id="spyn"></span>
              </div>
              <div class="panel-body">
                <ul class="list-group" id="proposals"></ul>
                <div class="well well-sm">
                  <div id="name_checks"></div>
                  <button class="btn btn-primary" onclick="Propose()">Propose</button>
                </div>
                <div class="well well-sm" id="proposal"></div>
                <button class="btn btn-success" onclick="Yes()">Yes</button>
                <button class="btn btn-danger" onclick="No()">No</button>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                Round 1 (<span id="voten0"></span>)
              </div>
              <div class="panel-body">
                <p><span id="0"></span></p>
                <p><button class="btn btn-success" onclick="Pass(0)">Pass</button> <button class="btn btn-danger" onclick="Fail(0)">Fail</button></p>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                Round 2 (<span id="voten1"></span>)
              </div>
              <div class="panel-body">
                <p><span id="1"></span></p>
                <p><button class="btn btn-success" onclick="Pass(1)">Pass</button> <button class="btn btn-danger" onclick="Fail(1)">Fail</button></p>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                Round 3 (<span id="voten2"></span>)
              </div>
              <div class="panel-body">
                <p><span id="2"></span></p>
                <p><button class="btn btn-success" onclick="Pass(2)">Pass</button> <button class="btn btn-danger" onclick="Fail(2)">Fail</button></p>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                Round 4 (<span id="voten3"></span>)
              </div>
              <div class="panel-body">
                <p><span id="3"></span></p>
                <p><button class="btn btn-success" onclick="Pass(3)">Pass</button> <button class="btn btn-danger" onclick="Fail(3)">Fail</button></p>
              </div>
            </div>
          </div>
          <div class="col-lg-2 col-md-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                Round 5 (<span id="voten4"></span>)
              </div>
              <div class="panel-body">
                <p><span id="4"></span></p>
                <p><button class="btn btn-success" onclick="Pass(4)">Pass</button> <button class="btn btn-danger" onclick="Fail(4)">Fail</button></p>
              </div>
            </div>
          </div>
        </div>
    </div>
	</body>
</html>
